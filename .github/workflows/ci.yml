name: Android and iOS CI Pipeline

on:
    push:
        branches: [ main ]
    pull_request:
        types: [ opened, synchronize ]

concurrency:
    group: ci-${{ github.ref }}-${{ github.head_ref }}
    cancel-in-progress: true

env:
    XCODE_VERSION: 16.4
    TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
    TRAKT_CLIENT_ID: ${{ secrets.TRAKT_CLIENT_ID }}
    TRAKT_CLIENT_SECRET: ${{ secrets.TRAKT_CLIENT_SECRET }}
    TRAKT_REDIRECT_URI: ${{ secrets.TRAKT_REDIRECT_URI }}

jobs:
    build-android:
        runs-on: ubuntu-latest
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        steps:
            -   name: ğŸšš Checkout Code
                uses: actions/checkout@v6

            -   name: ğŸ˜ Setup Gradle Environment
                uses: ./.github/actions/setup-gradle

            -   name: ğŸ”¥ Install google-services.json
                env:
                    GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
                run: |
                    if [ -n "$GOOGLE_SERVICES_JSON" ]; then
                      echo "$GOOGLE_SERVICES_JSON" | base64 --decode > app/google-services.json
                    else
                      echo "warning: GOOGLE_SERVICES_JSON secret not set â€” Firebase will be disabled"
                    fi

            -   name: ğŸ¤– Build Android App
                run: |
                    ./gradlew clean \
                      :app:assembleRelease \
                      :app:bundleRelease \
                      -Pandroidx.baselineprofile.skipgeneration=true \
                        -Pcompose.enableCompilerMetrics=true \
                        -Pcompose.enableCompilerReports=true \
                        -Papp.debugOnly=false \
                      --no-configuration-cache


    android-lint:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v6

            -   name: ğŸ˜ Setup Gradle Environment
                uses: ./.github/actions/setup-gradle

            -   name: Lint Project
                run: ./gradlew :app:lintRelease -Papp.debugOnly=false

            -   name: Upload Lint Report
                if: ${{ !cancelled() }}
                uses: actions/upload-artifact@v7
                with:
                    name: android-lint-report
                    path: '**/build/reports/lint-results-*.html'

    spotless:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v6

            -   name: ğŸ˜ Setup Gradle Environment
                uses: ./.github/actions/setup-gradle

            -   name: Run Spotless
                run: ./gradlew spotlessCheck -Papp.debugOnly=false --no-configuration-cache

    dependency-health:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v6

            -   name: ğŸ˜ Setup Gradle Environment
                uses: ./.github/actions/setup-gradle

            -   name: Dependency Health
                run: ./gradlew buildHealth -Papp.debugOnly=false

            -   name: Upload Dependency health Report
                uses: actions/upload-artifact@v7
                if: always()
                with:
                    name: dependency-health-report
                    path: '**/build/reports/dependency-analysis/build-health-report.txt'

    jvm-test:
        runs-on: ubuntu-latest
        steps:
            -   uses: actions/checkout@v6

            -   name: ğŸ˜ Setup Gradle Environment
                uses: ./.github/actions/setup-gradle

            -   name: Run JVM Tests
                run: ./gradlew jvmTest -Papp.debugOnly=false

            -   name: Upload Test Reports
                uses: actions/upload-artifact@v7
                if: always()
                with:
                    name: test-report
                    path: '**/build/reports/*'

    # TODO:: Investigate Freezing test
    #    common-ios-test:
    #        runs-on: macos-latest
    #
    #        steps:
    #            -   name: Checkout
    #                uses: actions/checkout@v6
    #
    #            -   name: Set up JDK
    #                uses: actions/setup-java@v5
    #                with:
    #                    distribution: ${{ env.DISTRIBUTION }}
    #                    java-version: ${{ env.JDK_VERSION }}
    #
    #            -   name: ğŸ˜ Setup Gradle
    #                uses: gradle/actions/setup-gradle@v5
    #
    #            -   name: Run Common iOS Unit Tests
    #                run: ./gradlew iosSimulatorArm64Test -Papp.enableIos=true -Papp.debugOnly=false
    #
    #            -   name: Upload Common Test Report
    #                uses: actions/upload-artifact@v6
    #                if: always()
    #                with:
    #                    name: common-ios-test-report
    #                    path: '**/build/reports/*'

    build-ios:
        runs-on: macos-15
        timeout-minutes: 60
        env:
            FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 60

        steps:
            -   name: ğŸšš Checkout project
                uses: actions/checkout@v6

            -   name: ğŸ“± Setup iOS Environment
                uses: ./.github/actions/setup-ios
                with:
                    xcode-version: ${{ env.XCODE_VERSION }}

            -   name: ğŸ”¥ Install GoogleService-Info.plist
                env:
                    GOOGLE_SERVICE_INFO: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST }}
                run: |
                    if [ -n "$GOOGLE_SERVICE_INFO" ]; then
                      echo "$GOOGLE_SERVICE_INFO" | base64 --decode > ios/ios/GoogleService-Info.plist
                    else
                      echo "warning: GOOGLE_SERVICE_INFO_PLIST secret not set â€” Firebase will be disabled"
                    fi

            -   name: ğŸ§± Build iOS App
                run: bundle exec fastlane build_tvmaniac

            -   name: Upload build artifacts
                uses: actions/upload-artifact@v7
                if: always()
                with:
                    name: ios-build
                    path: |
                        build/
                        fastlane/logs

    swift-lint:
        runs-on: macos-latest

        steps:
            -   name: ğŸšš Checkout project
                uses: actions/checkout@v6

            -   name: ğŸ’ Set up Ruby
                uses: ruby/setup-ruby@v1
                with:
                    bundler-cache: true

            -   name: ğŸ“¦ Install Swift Lint
                run: brew install swiftlint

            -   name: ğŸ” Run SwiftLint
                run: bundle exec fastlane ios lint

    ios-snapshot-test:
        runs-on: macos-15
        timeout-minutes: 60
        env:
            FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 60

        steps:
            -   name: ğŸšš Checkout project
                uses: actions/checkout@v6

            -   name: ğŸ“± Setup iOS Environment
                uses: ./.github/actions/setup-ios
                with:
                    xcode-version: ${{ env.XCODE_VERSION }}

            -   name: ğŸ“± List Available Simulators
                run: xcrun simctl list devices

            -   name: ğŸ“¸ Run Snapshot Tests
                run: bundle exec fastlane snapshot_tests

            -   name: Upload test results
                uses: actions/upload-artifact@v7
                if: always()
                with:
                    name: snapshot-test-results
                    path: |
                        fastlane/test_output
                        fastlane/logs
                        derived_data/Logs/Test
